<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold dark:text-white">Users</h1>
    @if (authService.hasPermission('USER_CREATE')) {
      <button
        (click)="openCreatePanel()"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Add User
      </button>
    }
  </div>

  <!-- Search & Filters Bar -->
  <div
    class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-4 mb-4 flex flex-wrap gap-4 items-center"
  >
    <!-- Search -->
    <div class="flex-1 min-w-[200px]">
      <input
        type="text"
        placeholder="Search by username or email..."
        (input)="onSearchInput($event)"
        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>

    <!-- Role Filter -->
    <select
      (change)="onRoleChange($any($event.target).value)"
      class="px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      <option value="">All Roles</option>
      @for (role of roles(); track role.id) {
        <option [value]="role.name">{{ role.name }}</option>
      }
    </select>

    <!-- Status Filter -->
    <select
      (change)="onStatusChange($any($event.target).value)"
      class="px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      <option value="">All Statuses</option>
      <option value="true">Active</option>
      <option value="false">Inactive</option>
    </select>

    <!-- Show Deleted Toggle -->
    @if (authService.hasPermission('USER_MANAGE')) {
      <label
        class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer"
      >
        <input
          type="checkbox"
          [checked]="showDeleted()"
          (change)="onShowDeletedChange($any($event.target).checked)"
          class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
        />
        Show Deleted
      </label>
    }
  </div>

  <!-- Bulk Action Bar -->
  @if (selectionCount() > 0) {
    <div
      class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-4 flex items-center gap-3"
    >
      <span class="text-sm font-medium text-blue-800 dark:text-blue-300"
        >{{ selectionCount() }} selected</span
      >
      <div class="flex gap-2 ml-auto">
        @if (!showDeleted()) {
          @if (authService.hasPermission('USER_UPDATE')) {
            <button
              (click)="bulkEnable()"
              class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700"
            >
              Enable
            </button>
            <button
              (click)="bulkDisable()"
              class="px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700"
            >
              Disable
            </button>
          }
          @if (authService.hasPermission('USER_DELETE')) {
            <button
              (click)="bulkDelete()"
              class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
            >
              Delete
            </button>
          }
        }
        <button
          (click)="clearSelection()"
          class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600"
        >
          Clear
        </button>
      </div>
    </div>
  }

  @if (loading()) {
    <div class="text-center py-8">
      <p class="dark:text-gray-300">Loading users...</p>
    </div>
  } @else if (error()) {
    <div
      class="bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-400 px-4 py-3 rounded"
    >
      {{ error() }}
    </div>
  } @else if (users()) {
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-700">
          <tr>
            <!-- Checkbox Column -->
            <th class="px-4 py-3 w-10">
              <input
                type="checkbox"
                [checked]="allOnPageSelected()"
                (change)="toggleAllOnPage()"
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
            </th>
            <th
              (click)="onSort('id')"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:text-gray-700 dark:hover:text-gray-200"
            >
              ID
              @if (sortField() === 'id') {
                <span>{{ sortDirection() === 'asc' ? ' &#9650;' : ' &#9660;' }}</span>
              }
            </th>
            <th
              (click)="onSort('username')"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:text-gray-700 dark:hover:text-gray-200"
            >
              Username
              @if (sortField() === 'username') {
                <span>{{ sortDirection() === 'asc' ? ' &#9650;' : ' &#9660;' }}</span>
              }
            </th>
            <th
              (click)="onSort('email')"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:text-gray-700 dark:hover:text-gray-200"
            >
              Email
              @if (sortField() === 'email') {
                <span>{{ sortDirection() === 'asc' ? ' &#9650;' : ' &#9660;' }}</span>
              }
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase"
            >
              Roles
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase"
            >
              Status
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          @for (user of users()!.content; track user.id) {
            <tr
              [ngClass]="{
                'bg-red-50': user.deletedAt,
                'dark:bg-red-900/20': user.deletedAt,
                'opacity-60': user.deletedAt,
              }"
            >
              <!-- Checkbox -->
              <td class="px-4 py-4 w-10">
                <input
                  type="checkbox"
                  [checked]="isSelected(user.id)"
                  (change)="toggleSelection(user.id)"
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm dark:text-gray-300">{{ user.id }}</td>
              <td
                class="px-6 py-4 whitespace-nowrap text-sm font-medium dark:text-white"
                [class.line-through]="user.deletedAt"
              >
                {{ user.username }}
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-sm dark:text-gray-300"
                [class.line-through]="user.deletedAt"
              >
                {{ user.email }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                @for (role of user.roles; track role.id) {
                  <span
                    class="inline-flex items-center px-2 py-1 mr-1 text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded"
                  >
                    {{ role.name }}
                  </span>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                @if (user.deletedAt) {
                  <span class="text-red-600 dark:text-red-400 font-medium">Deleted</span>
                } @else if (user.enabled) {
                  <span class="text-green-600 dark:text-green-400">Active</span>
                } @else {
                  <span class="text-yellow-600 dark:text-yellow-400">Inactive</span>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                @if (user.deletedAt) {
                  @if (authService.hasPermission('USER_MANAGE')) {
                    <button
                      (click)="restoreUser(user.id)"
                      class="text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300 mr-3"
                    >
                      Restore
                    </button>
                  }
                  @if (
                    authService.hasPermission('USER_DELETE') &&
                    authService.hasPermission('SYSTEM_MANAGE')
                  ) {
                    <button
                      (click)="purgeUser(user)"
                      class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300"
                    >
                      Purge
                    </button>
                  }
                } @else {
                  @if (authService.hasPermission('USER_UPDATE')) {
                    <button
                      (click)="openEditPanel(user)"
                      class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-3"
                    >
                      Edit
                    </button>
                  }
                  @if (authService.hasPermission('USER_DELETE')) {
                    <button
                      (click)="deleteUser(user.id)"
                      class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300"
                    >
                      Delete
                    </button>
                  }
                }
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                @if (showDeleted()) {
                  No deleted users found.
                } @else if (searchTerm() || selectedRole() || selectedStatus() !== '') {
                  No users match your filters. Try adjusting your search criteria.
                } @else {
                  No users found.
                }
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Pagination -->
      <div
        class="bg-gray-50 dark:bg-gray-700 px-6 py-3 flex items-center justify-between border-t dark:border-gray-600"
      >
        <div class="text-sm text-gray-700 dark:text-gray-300">
          Showing {{ users()!.number * users()!.size + 1 }} to
          {{ Math.min((users()!.number + 1) * users()!.size, users()!.totalElements) }} of
          {{ users()!.totalElements }} results
        </div>
        <div class="flex gap-2">
          <button
            (click)="previousPage()"
            [disabled]="page() === 0"
            class="px-4 py-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Previous
          </button>
          <button
            (click)="nextPage()"
            [disabled]="page() >= users()!.totalPages - 1"
            class="px-4 py-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  }
</div>

<!-- Edit Panel Overlay -->
@if (panelOpen()) {
  <app-user-edit-panel
    [user]="editingUser()"
    [roles]="roles()"
    (close)="closeEditPanel()"
    (saved)="onUserUpdated()"
  />
}
